---
title: å»ºç«‹è‡ªå·±çš„ Tile Server
date: 2024-04-08 22:00:00
tags: ["çŸ­ç¯‡", "ç¨‹å¼", "é€²éš", "GIS"]
description: ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘äº†è§£äº† OSM è³‡æ–™çš„å…§å®¹ï¼Œä»¥åŠå¦‚ä½•å°‡ä»–å€‘å°å…¥åˆ° PostGIS è³‡æ–™åº«ä¸­ä¾›æˆ‘å€‘ä½¿ç”¨ã€‚ç¾åœ¨æˆ‘å€‘å°‡åˆ©ç”¨é€™äº›è³‡æ–™å»ºç«‹æˆ‘å€‘çš„ Vector Tiles API serverã€‚
authors: ivan
slug: 2024/04/08/make-your-own-tile-servers
image: ./gis_og.png
---
[ä¸Šä¸€ç¯‡æ–‡ç« ](../load-osm-data-into-postgis/index.mdx)ä¸­ï¼Œæˆ‘å€‘äº†è§£äº† OSM è³‡æ–™çš„å…§å®¹ï¼Œä»¥åŠå¦‚ä½•å°‡ä»–å€‘å°å…¥åˆ° PostGIS è³‡æ–™åº«ä¸­ä¾›æˆ‘å€‘ä½¿ç”¨ã€‚ç¾åœ¨æˆ‘å€‘å°‡åˆ©ç”¨é€™äº›è³‡æ–™å»ºç«‹æˆ‘å€‘çš„ Vector Tiles API serverã€‚


{/* truncate */}

## (é¸æ“‡æ€§)å‰ç½®æº–å‚™äº‹é …
æˆ‘å€‘é è¨ˆè¦è£½ä½œåŒ…å«è¡Œæ”¿å€åŸŸé‚Šç•Œã€æµ·æ´‹ä»¥åŠé“è·¯çš„åœ°åœ–ï¼Œåœ¨é–‹å§‹è£½ä½œ Tile Server ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆç¢ºå®šé€™äº›è³‡æ–™éƒ½æº–å‚™å®Œæˆï¼Œæˆ‘æŠŠæº–å‚™è³‡æ–™çš„ Scripts æ”¾åœ¨ Github ä¸Šï¼Œæ‚¨å¯ä»¥è·Ÿéš¨æˆ‘ä¾†æº–å‚™ç›¸å°æ‡‰çš„è³‡ï¼›ä¸éï¼Œæ‚¨ä¹Ÿå¯ä»¥æº–å‚™è‡ªå·±çš„è³‡æ–™ï¼Œæ‚¨å¯ä»¥ç€è¦½éé–‹ç™¼æµç¨‹å¾Œä½¿ç”¨ä»»ä½•èªè¨€ä¾†é–‹ç™¼ã€‚

1. å®‰è£ [osm2pgsql](https://osm2pgsql.org/) ä»¥åŠ [ogr2ogr](https://gdal.org/programs/ogr2ogr.html)ï¼Œæˆ‘å€‘å°‡ç”¨é€™å…©å€‹å·¥å…·å°å…¥è³‡æ–™ã€‚
2. å®‰è£ [Docker](https://www.docker.com/products/docker-desktop/)ï¼Œæˆ‘å€‘å°‡åˆ©ç”¨ Docker å¿«é€Ÿå•Ÿå‹• PostGISã€‚
3. å®‰è£ [NodeJS](https://nodejs.org/en)ï¼Œç¯„ä¾‹ç¨‹å¼å°‡æœƒä½¿ç”¨ NodeJS ä¾†é–‹ç™¼ã€‚
4. ä¸‹è¼‰ç¯„ä¾‹å°ˆæ¡ˆã€‚
    ```bash
    git clone git@github.com:oscar60310/tile-server-demo.git && cd ./tile-server-demo
    ```
5. å•Ÿå‹• PostGIS ä»¥åŠ [Maputnik](https://github.com/maplibre/maputnik)ï¼Œæˆ‘å€‘ä¸‹ç¯‡æ–‡ç« æœƒä½¿ç”¨ Maputnik ç·¨è¼¯æ¨£å¼ã€‚
    ```bash
    docker compose up -d
    ```
6. ä¸‹è¼‰ OSM è³‡æ–™ï¼Œä½¿ç”¨ OSM è³‡æ–™é ˆéµå®ˆå…¶[è¦ç¯„](https://www.openstreetmap.org/copyright)ã€‚é€™å€‹å…©å€‹ Scripts æœƒå°å…¥å°ç£åœ°å€çš„è³‡æ–™ä»¥åŠæµ·æ´‹çš„è³‡æ–™ï¼Œä¸¦è¨­å®šå¥½ PostGISã€‚
    ```bash
    ./scripts/01_prepare_osm_data.sh
    ./scripts/02_prepare_osm_water_data.sh
    ```
7. åˆå§‹åŒ–å°ˆæ¡ˆã€‚
    ```bash
    npm i
    ```

## è¼”åŠ© Function - åº§æ¨™è½‰æ›
æˆ‘å€‘åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­[æåˆ°](../how-web-maps-work/index.mdx#%E5%9C%96%E7%A3%9A%E7%B3%BB%E7%B5%B1)ï¼Œåœ–ç£šç³»çµ±åŒ…å«äº†ä¸‰å€‹åƒæ•¸ï¼šZ(Zoom) / X / Yï¼Œæˆ‘å€‘å°‡è¦åœ¨è³‡æ–™åº«ä¸­æ™‚å¸¸æœå°‹æŸå€‹åœ–ç£šæ‰€åŒ…å«çš„å…§å®¹ï¼Œé€™æ™‚å€™æˆ‘å€‘å¯ä»¥åœ¨è³‡æ–™åº«ä¸­å»ºç«‹ Function ä¾†å¹«åŠ©æˆ‘å€‘ï¼š
:::info
é€™å€‹ Helper Function ä¾†è‡ª [Mapbox](https://github.com/mapbox/postgis-vt-util/blob/master/src/TileBBox.sql) å°ˆæ¡ˆã€‚
:::
:::info
é€™å€‹ Helper Function å·²ç¶“åœ¨ 01_prepare_osm_data.sh å»ºç«‹ã€‚
:::

```sql
create or replace function TileBBox (z int, x int, y int, srid int = 3857)
  returns geometry
  language plpgsql immutable as
$func$
declare
  max numeric := 20037508.34;
  res numeric := (max*2)/(2^z);
  bbox geometry;
begin
  bbox := ST_MakeEnvelope(
      -max + (x * res),
      max - (y * res),
      -max + (x * res) + res,
      max - (y * res) - res,
      3857
  );
  if srid = 3857 then
      return bbox;
  else
      return ST_Transform(bbox, srid);
  end if;
end;
$func$;
```
æˆ‘å€‘ä½¿ç”¨ `ST_MakeEnvelope` ä¾†å»ºç«‹ä¸€å€‹çŸ©å½¢ï¼Œåˆ©ç”¨è¼¸å…¥çš„ Z/X/Y åº§æ¨™ä¾†ç®—å‡ºçŸ©å½¢çš„ä½ç½®ã€‚æ¯”å¦‚èªªé€™å€‹æ˜¯ `SELECT TileBBox(16, 54895, 28069)` çš„çµæœï¼š
![](bbox.png)

æœ‰å€‹é€™å€‹çŸ©å½¢ï¼Œæˆ‘å€‘å°±å¯ä»¥å–å‡ºç›¸å°æ‡‰çš„çµæœäº†ï¼

## å–å‡ºé“è·¯è³‡æ–™
æˆ‘å€‘å…ˆå¾é“è·¯è³‡æ–™é–‹å§‹ï¼Œé“è·¯çš„è³‡æ–™å„²å­˜åœ¨ `planet_osm_line` è¡¨ä¸­ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ `ST_Intersects` Function ä¾†æ‰¾å‡ºå’Œç›®æ¨™åœ–ç£šçŸ©å½¢æœ‰äº¤æœƒçš„é …ç›®ï¼š

```sql
SELECT
  name,
  highway,
  way
FROM
  planet_osm_line
WHERE
  ST_Intersects (TileBBox (16, 54895, 28069), way)
  AND highway IS NOT NULL --- OSM è³‡æ–™ä¸­åŒ…å«å…¶ä»–ç·šè·¯è³‡æ–™åƒæ˜¯å…¬è»Šè·¯ç¶²ç­‰ç­‰ï¼Œæˆ‘å€‘æš«æ™‚ä¸éœ€è¦ä»–å€‘ã€‚
  AND name IS NOT NULL
```
çµæœå¦‚åœ–ï¼š
![](./road-1.png)

## è£åˆ‡ä¸¦ç·¨ç¢¼è³‡æ–™
ä¸Šä¸€å€‹æ­¥é©Ÿå·²ç¶“æ‹¿åˆ°æ‰€æœ‰å’Œåœ–ç£šæœ‰äº¤æœƒï¼Œä¹Ÿå°±æ˜¯éœ€è¦é¡¯ç¤ºåœ¨åœ–ç£šå…§çš„é“è·¯ï¼Œä½†å¾çµæœä¾†çœ‹å¯ä»¥ç™¼ç¾ï¼Œé€™äº›é“è·¯å¾ˆå¸¸æ˜¯è¶…å‡ºåœ–ç£šçš„ï¼ˆç•¢ç«Ÿèˆˆå»ºé“è·¯å¯ä¸æ˜¯åœ¨åœ–ç£šä¸Šè“‹çš„ğŸ˜‚)ï¼Œæˆ‘å€‘éœ€è¦æŠŠä»–å€‘æ‰åˆ‡æˆç¬¦åˆåœ–ç£šçš„å¤§å°ã€‚å¦ä¸€æ–¹é¢ï¼Œæˆ‘å€‘å°‡æœƒé€éç¶²è·¯å‚³è¼¸åœ–ç£šè³‡æ–™ï¼Œé€™æ™‚å€™éœ€è¦ä¸€å€‹æœ‰æ•ˆç‡çš„ç·¨ç¢¼ï¼Œåœ–ç£šçš„ç·¨ç¢¼æ¨™æº–å·²ç¶“ç”± Mapbox [å®šç¾©](https://github.com/mapbox/vector-tile-spec)ï¼Œç›®å‰å¤§éƒ¨åˆ†çš„å®¢æˆ¶ç«¯(è² è²¬æŒ‰ç…§åœ–ç£šè³‡æ–™ç¹ªè£½åœ°åœ–çš„è»Ÿé«”)éƒ½æ”¯æ´é€™å€‹æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯ Mapbox Vector Tile (MVT)ï¼Œæˆ‘å€‘å°‡åœ¨ PostGIS ä¸­ç›´æ¥æŠŠçµæœè½‰ç‚º MVTã€‚
[ST_AsMVTGeom](https://postgis.net/docs/ST_AsMVTGeom.html) Function å¯ä»¥è®“æˆ‘å€‘è¼•æ˜“åœ°åšåˆ°é€™ä»¶äº‹æƒ…ï¼Œåªéœ€è¦æŠŠçµæœå’Œåœ–ç£šé‚Šç•Œå‚³çµ¦å®ƒå°±å¥½ï¼š

```sql
SELECT
  name,
  highway,
  ST_AsMVTGeom (way, TileBBox (16, 54895, 28069)) way
FROM
  planet_osm_line
WHERE
  ST_Intersects (TileBBox (16, 54895, 28069), way)
  AND highway IS NOT NULL --- OSM è³‡æ–™ä¸­åŒ…å«å…¶ä»–ç·šè·¯è³‡æ–™åƒæ˜¯å…¬è»Šè·¯ç¶²ç­‰ç­‰ï¼Œæˆ‘å€‘æš«æ™‚ä¸éœ€è¦ä»–å€‘ã€‚
  AND name IS NOT NULL
```

ç¾åœ¨çš„çµæœå°±æœƒæ˜¯è£åˆ‡å®Œæˆçš„äº†ï¼š
![](./road-2.png)

## å–å‡ºæµ·æ´‹å’Œè¡Œæ”¿å€é‚Šç•Œçš„è³‡æ–™
é¦–å…ˆï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ [ST_AsMVT](https://postgis.net/docs/ST_AsMVT.html) æŠŠå¤šå€‹ MVT æ•´åˆåœ¨ä¸€èµ·ï¼Œä¸¦å¹«æ¯å€‹ MVT å‘½åï¼Œä¹‹å¾Œç¹ªåœ–æ™‚æˆ‘å€‘å¯ä»¥é‡å°ä¸åŒçš„ MVT ç¹ªè£½ã€‚æ¥è‘—æˆ‘å€‘æŠŠ API Server æ¥æ”¶åˆ°çš„åƒæ•¸å¸¶é€²æˆ‘å€‘çš„ SQL æŸ¥è©¢ä¸­ï¼š
:::info
`{{ context.params.x }}` æ˜¯ [VulcanSQL](https://vulcansql.com/) å¸¶å…¥åƒæ•¸çš„èªæ³•ï¼Œæ‚¨æ‡‰è©²è¦ä½¿ç”¨ç›¸å°æ‡‰çš„èªæ³•ä¾†å¸¶å…¥åƒæ•¸ã€‚
é€™å€‹ SQL æª”æ¡ˆä½æ–¼å°ˆæ¡ˆçš„ [./sqls/tiles.sql](https://github.com/oscar60310/tile-server-demo/blob/main/sqls/tiles.sql)ã€‚
:::

```sql
SELECT
  ST_AsMVT (data.*, 'road') mvt
FROM
  (
    SELECT
      name,
      highway,
      ST_AsMVTGeom (way, TileBBox ({{ context.params.z }}, {{ context.params.x }}, {{ context.params.y }}), 4096, 256, true) way
    FROM
      planet_osm_line
    WHERE
      ST_Intersects (TileBBox ({{ context.params.z }}, {{ context.params.x }}, {{ context.params.y }}), way)
      AND highway IS NOT NULL
      AND name IS NOT NULL
  ) AS data
```
æ¥ä¸‹ä¾†æˆ‘å€‘å¯ä»¥æŒ‰ç…§ä¸€æ¨£çš„æ–¹å¼å–å¾—æµ·æ´‹(ä½æ–¼ `water` è¡¨ä¸­)å’Œè¡Œæ”¿å€åŸŸ(ä½æ–¼ `planet_osm_polygon` æ¨™ä¸­)ï¼Œæˆ‘å€‘åŠ å…¥ CTE ä¾†è®“ SQL å¥½è®€ä¸€äº›ï¼š
```sql
WITH all_data AS (
  SELECT
      'road' AS feature,
      name,
      highway AS category,
      way
    FROM
      planet_osm_line
    WHERE
      highway IS NOT NULL
      AND name IS NOT NULL
    
    UNION
    
    SELECT
      'boundary' AS feature,
      name,
      NULL AS category,
      way
    FROM
      planet_osm_polygon
    WHERE
      admin_level = '4' --- åªå– admin level = 4 çš„è³‡æ–™
    
    UNION
    
    SELECT
      'water' AS feature,
      NULL AS name,
      NULL AS category,
      way
    FROM
      water
),
tile_data AS (
  SELECT 
    all_data.feature,
    all_data.name,
    all_data.category,
  	ST_AsMVTGeom (all_data.way, TileBBox ({{ context.params.z }}, {{ context.params.x }}, {{ context.params.y }})) way
  FROM
    all_data
  WHERE
    ST_Intersects (TileBBox ({{ context.params.z }}, {{ context.params.x }}, {{ context.params.y }}), all_data.way)
)
SELECT
  ST_AsMVT (tile_data.*, tile_data.feature) mvt
FROM tile_data
GROUP BY tile_data.feature
```
:::warning
æˆ‘å€‘ä¸¦æ²’æœ‰å¾ˆå¥½çš„è™•ç† Z å¾ˆå°çš„æ™‚å€™æŸ¥è©¢å¤§é‡è³‡æ–™çš„å•é¡Œï¼Œæ‚¨å¯ä»¥è‡ªè¡Œæ±ºå®šè¦å¦‚ä½•æ‡‰å°ï¼Œæ¯”å¦‚èªª Z > 10 æ‰æŸ¥è©¢é“è·¯ç­‰ç­‰ã€‚
:::

## å•Ÿå‹• Tile Server
ç¾åœ¨ï¼Œæˆ‘å€‘å·²ç¶“å»ºç«‹å¥½ API Server ä¾†æŸ¥è©¢è³‡æ–™å’Œç·¨ç¢¼äº†ï¼Œæ‚¨å¯ä»¥åˆ° [./sqls/tiles.sql](https://github.com/oscar60310/tile-server-demo/blob/main/sqls/tiles.sql) æŸ¥çœ‹æœ€çµ‚çµæœã€‚

å•Ÿå‹• Tile serverï¼š
```bash
npm start
```

æ¸¬è©¦ Tile server
å‰å¾€ [http://localhost:3000/api/tiles/16/54895/28069.mvt](http://localhost:3000/api/tiles/16/54895/28069.mvt)ï¼Œæ‡‰è©²è¦èƒ½æˆåŠŸä¸‹è¼‰æª”æ¡ˆã€‚

æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘å¯ä»¥æº–å‚™ç¹ªè£½åœ°åœ–äº†ï¼è«‹åƒè€ƒä¸‹ç¯‡æ–‡ç« ä¾†å¯¦ä½œã€‚ 

import GisSeries from "../_gis-series.mdx";

<GisSeries />

